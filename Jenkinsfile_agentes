pipeline {
    agent any
    environment {
        STAGE = "staging"
        AWS_REGION = "us-east-1"
    }
    stages {
        stage('Get Code') {
            steps {
                script {
                    // Print info
                    echo "[${STAGE_NAME}] Building branch ${GIT_BRANCH} of repository ${GIT_URL}"
                    sh 'echo "User: $(whoami), IP: $(hostname -I)"'

                    // Add the workspace as a safe directory for Git
                    sh 'git config --global --add safe.directory ${WORKSPACE}'

                    // Clone the repository and check out the specified branch
                    checkout([$class: 'GitSCM',
                        branches: [[name: "${GIT_BRANCH}"]],
                        userRemoteConfigs: [[url: "${GIT_URL}"]]
                    ])

                    // Clone the configuration repository and copy the correct samconfig.toml
                    sh '''
                    echo "Fetching samconfig.toml from unir-cp1-c-sam-config (${STAGE} branch)..."
                    git clone --depth 1 --branch ${STAGE} https://github.com/charlstown/unir-cp1-c-sam-config.git config_repo

                    # Move the config file to the expected location
                    mv config_repo/samconfig.toml .

                    # Clean up the temporary repo
                    rm -rf config_repo

                    echo "samconfig.toml successfully fetched for ${STAGE} environment."
                    '''

                    // Run setup
                    sh 'bash setup.sh'
                }
            }
        }
        stage('Static Test') {
            agent { label 'agent-1' }
            environment {
                PYTHONPATH="${WORKSPACE}"
                STAGE = "staging"
                AWS_REGION = "us-east-1"
            }
            steps {
                sh 'echo "User: $(whoami), IP: $(hostname -I)"'
                // Run flake8 with pylint
                sh '''
                python3 -m flake8 --format=pylint --exit-zero --output-file=result-flake8.out src
                bandit -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                '''
                // Publish Flake8 results (without quality gates)
                recordIssues(tools: [flake8(pattern: 'result-flake8.out')])

                // Publish Bandit security scan results (without quality gates)
                recordIssues(tools: [pyLint(name: 'bandit', pattern: 'bandit.out')])          
            }
        }
        stage('Deploy') {
            steps {
                script {
                    sh 'echo "User: $(whoami), IP: $(hostname -I)"'
                    sh '''
                    # check aws identity
                    aws sts get-caller-identity

                    # Build the application
                    sam build --debug

                    # Validate the CloudFormation template
                    sam validate --region ${AWS_REGION}

                    # Deploy using the downloaded samconfig.toml
                    sam deploy --region ${AWS_REGION} --no-confirm-changeset --no-fail-on-empty-changeset --debug
                    '''
                }
            }
        }
        stage('Rest') {
            agent { label 'agent-2' }
            environment {
                PYTHONPATH="${WORKSPACE}"
                STAGE = "staging"
                AWS_REGION = "us-east-1"
            }
            steps {
                sh 'echo "User: $(whoami), IP: $(hostname -I)"'
                // Get API BASE_URL
                sh '''
                # Fetch the API Gateway URL from CloudFormation stack
                export BASE_URL=$(aws cloudformation describe-stacks \
                    --stack-name todo-list-aws-${STAGE} \
                    --region ${AWS_REGION} \
                    --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                    --output text)

                echo "API Gateway base url: $BASE_URL"

                BASE_URL=${BASE_URL} python3 -m pytest --junitxml=result-rest.xml test/integration/todoApiTest.py
                '''

                // Publish REST test results
                junit 'result-rest.xml'
            }
        }
        stage('Promote') {
            environment {
                GITHUB_TOKEN = credentials('GITHUB_TOKEN')  // Load GitHub Token
                GITHUB_USER = credentials('GITHUB_USER')  // Load GitHub User
                GITHUB_EMAIL = credentials('GITHUB_EMAIL')  // Load GitHub Email
                TAG_NAME = "stable"
                STAGE = "staging"
                AWS_REGION = "us-east-1"
            }
            steps {
                script {
                    sh 'echo "User: $(whoami), IP: $(hostname -I)"'
                    sh '''
                    # Configuring Git & adding merge rule for ours
                    echo "Configuring Git"
                    git config --global user.name "$GITHUB_USER"
                    git config --global user.email "$GITHUB_EMAIL"
                    git remote set-url origin "https://x-access-token:$GITHUB_TOKEN@${GIT_URL#https://}"

                    # Tag the last stable commit as stable
                    LAST_COMMIT=$(git rev-parse HEAD)
                    echo "Tagging last stable commit: $LAST_COMMIT"
                    git tag -f "$TAG_NAME" "$LAST_COMMIT"
                    git push origin "$TAG_NAME" --force

                    # Merge dev into master if no new commits exist in master
                    git fetch origin master
                    git checkout master || git checkout -b master origin/master
                    echo "Merging ${GIT_BRANCH} into master..."
                    git merge ${GIT_BRANCH} || { echo "Merge failed! No fast-forward possible."; exit 1; }

                    # Push changes
                    echo "Pushing changes to master..."
                    git push origin master
                    '''
                }
            }
        }
    }
    post {
        success {
            // Run continuous deployment pipeline
            build job: 'cp1-4-cd-agents', wait: false
        }
        always {
            // Clean the workspace after the pipeline completes
            cleanWs()
            // Clean workspaces on all agents
            node('agent-1') {
                cleanWs()
            }
            node('agent-2') {
                cleanWs()
            }
        }
    }
}